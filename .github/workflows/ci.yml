name: CI

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      PYTHONHASHSEED: "42"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11.10"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-lock.txt

      - name: Compile source files (warnings as errors)
        run: python -W error -m py_compile src/*.py deployment/*.py benchmarking/*.py hardware_aware_ml/*.py real_time_pipelines/*.py scripts/*.py

      - name: End-to-end system build
        run: |
          python -m src.train
          python deployment/export_onnx.py
          python deployment/quantize_onnx.py
          python deployment/parity_check.py --abs-tol 0.04 --mean-tol 0.01 --batch-size 256
          python benchmarking/statistical_benchmark.py --runs 5 --batch-size 256
          python hardware_aware_ml/tradeoff_experiments.py
          python benchmarking/dashboard.py
          python real_time_pipelines/unified_pipeline.py --mode both
          python scripts/reproducibility_check.py

      - name: API smoke tests (warnings as errors)
        run: |
          python -W error - <<'PY'
          from fastapi.testclient import TestClient
          from src.api import app as pred_app
          from src.qa_api import app as qa_app

          payload = {
              "student_country": "US",
              "days_on_platform": 100,
              "minutes_watched": 180.0,
              "courses_started": 3,
              "practice_exams_started": 2,
              "practice_exams_passed": 1,
              "minutes_spent_on_exams": 40.0,
          }

          with TestClient(pred_app) as c:
              health = c.get("/health")
              assert health.status_code == 200, health.text
              r = c.post("/predict", json=payload)
              assert r.status_code == 200, r.text
              drift = c.get('/monitoring/drift')
              assert drift.status_code == 200, drift.text

          q_payload = {
              "question_lecture": "Intro",
              "question_title": "Question",
              "question_body": "What is covered?"
          }

          with TestClient(qa_app) as c:
              r = c.post('/qa', json=q_payload)
              assert r.status_code == 200, r.text
          print("api smoke tests passed")
          PY

      - name: Integration and artifact schema tests
        run: python -m unittest discover -s tests -p 'test_*.py'
