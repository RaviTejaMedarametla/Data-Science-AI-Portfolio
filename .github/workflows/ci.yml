name: CI

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      PYTHONHASHSEED: "42"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11.10"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Compile source files (warnings as errors)
        run: python -W error -m py_compile src/*.py

      - name: Train pipeline smoke test
        run: python -m src.train

      - name: API smoke tests (warnings as errors)
        run: |
          python -W error - <<'PY'
          from fastapi.testclient import TestClient
          from src.api import app as pred_app
          from src.qa_api import app as qa_app

          payload = {
              "student_country": "US",
              "days_on_platform": 100,
              "minutes_watched": 180.0,
              "courses_started": 3,
              "practice_exams_started": 2,
              "practice_exams_passed": 1,
              "minutes_spent_on_exams": 40.0,
          }

          with TestClient(pred_app) as c:
              health = c.get("/health")
              assert health.status_code == 200, health.text
              r = c.post("/predict", json=payload)
              assert r.status_code == 200, r.text
              drift = c.get('/monitoring/drift')
              assert drift.status_code == 200, drift.text

          q_payload = {
              "question_lecture": "Intro",
              "question_title": "Question",
              "question_body": "What is covered?"
          }

          with TestClient(qa_app) as c:
              r = c.post('/qa', json=q_payload)
              assert r.status_code == 200, r.text
          print("api smoke tests passed")
          PY
